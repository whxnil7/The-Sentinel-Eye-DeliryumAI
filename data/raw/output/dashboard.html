<!doctype html>
<html lang="es">
<meta charset="utf-8">
<title>Sentinel Eye – Dashboard QC/Stab/Mov</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #0b1020;
  --panel: #11182b;
  --panel-2: #121c31;
  --stroke: #1f2a44;
  --text: #e7edf7;
  --muted: #9fb0c8;
  --accent: #6dd3ff;
  --accent-2: #a47cff;
  --accent-3: #22c55e;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  padding: 32px;
  font-family: "Inter", "Space Grotesk", system-ui, -apple-system, sans-serif;
  background: radial-gradient(120% 120% at 15% 20%, rgba(109,211,255,0.14), transparent 40%),
              radial-gradient(90% 90% at 80% 10%, rgba(164,124,255,0.12), transparent 45%),
              radial-gradient(120% 120% at 50% 80%, rgba(34,197,94,0.10), transparent 50%),
              var(--bg);
  color: var(--text);
}
.page {
  max-width: 1400px;
  margin: 0 auto;
}
.hero {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  background: linear-gradient(145deg, var(--panel), var(--panel-2));
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 14px 16px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}
.title {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.title h1 {
  margin: 0;
  font-size: 28px;
  letter-spacing: 0.2px;
}
.title span {
  color: var(--muted);
  font-size: 14px;
}
.upload {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(120deg, #1f2f4a, #19263e);
  border: 1px solid #2a3b5d;
  border-radius: 12px;
  padding: 10px 14px;
  color: var(--text);
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 10px 35px rgba(0,0,0,0.25);
}
.upload input { display: none; }
.status {
  margin: 12px 2px 18px;
  color: var(--muted);
  font-size: 14px;
}
.grid {
  display: grid;
  gap: 16px;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
}
.card {
  background: linear-gradient(145deg, var(--panel), var(--panel-2));
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 14px 14px 10px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}
.card h3 {
  margin: 0 0 10px;
  font-size: 16px;
  letter-spacing: 0.3px;
  color: var(--text);
}
.big { grid-column: 1 / -1; }
canvas { width: 100%; height: 380px; }
.badge-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.badge {
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 12px;
  color: var(--text);
  border: 1px solid var(--stroke);
}
.badge.qc { background: rgba(6,182,212,0.12); border-color: rgba(6,182,212,0.4); }
.badge.stab { background: rgba(234,179,8,0.12); border-color: rgba(234,179,8,0.4); }
.badge.mot { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.45); }
@media (max-width: 720px) {
  body { padding: 20px; }
  canvas { height: 320px; }
  .hero { flex-direction: column; align-items: flex-start; }
}
</style>

<div class="page">
  <div class="hero">
    <div class="title">
      <h1>Dashboard Sentinel Eye</h1>
      <span>QC · Estabilidad · Movimiento</span>
      <div class="badge-row">
        <div class="badge qc">QC</div>
        <div class="badge stab">dx/dy + vib</div>
        <div class="badge mot">Regiones / Área</div>
      </div>
    </div>
    <label class="upload">
      <span>Selecciona qc_metrics.csv</span>
      <input type="file" id="file" accept=".csv">
    </label>
  </div>
  <div id="status" class="status"></div>

  <div class="grid">
    <div class="card big"><h3>Módulo 1: Calidad (QC)</h3><canvas id="qcChart"></canvas></div>
    <div class="card"><h3>Módulo 2: Estabilidad</h3><canvas id="stabChart"></canvas></div>
    <div class="card"><h3>Módulo 3: Movimiento</h3><canvas id="motChart"></canvas></div>
    <div class="card">
      <h3>Drift & Telemetría (simulada)</h3>
      <div id="driftStats" class="status" style="margin:4px 0 10px;"></div>
      <button id="simulatePayload" class="upload" style="padding:8px 12px; border-radius:10px;">Simular payload JSON</button>
      <pre id="payloadBox" style="margin-top:10px; background:#0b1222; border:1px solid var(--stroke); border-radius:10px; padding:10px; color:#cbd5e1; min-height:110px; white-space:pre-wrap;"></pre>
    </div>
  </div>
</div>

<script>
Chart.defaults.color = "#cbd5e1";
Chart.defaults.font.family = "Inter, Space Grotesk, system-ui, -apple-system, sans-serif";
Chart.defaults.plugins.legend.labels.usePointStyle = true;

function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  const headers=lines.shift().split(",").map(h=>h.trim());
  return lines.map(line=>{
    const cols=line.split(",");
    const row={};
    headers.forEach((h,i)=>row[h]=cols[i]?cols[i].trim():"");
    return row;
  });
}
function percentile(arr, p){
  if(!arr.length) return 0;
  const sorted=[...arr].sort((a,b)=>a-b);
  const idx=(p/100)*(sorted.length-1);
  const lo=Math.floor(idx), hi=Math.ceil(idx);
  if(lo===hi) return sorted[lo];
  const w=idx-lo;
  return sorted[lo]*(1-w)+sorted[hi]*w;
}
function makeLineChart(canvasId, labels, datasets){
  const ctx=document.getElementById(canvasId).getContext("2d");
  if(ctx._chart){ ctx._chart.destroy(); }
  ctx._chart=new Chart(ctx,{type:"line",data:{labels,datasets},options:{
    responsive:true, maintainAspectRatio:false, interaction:{mode:"index", intersect:false},
    scales:{
      x:{ticks:{color:"#cbd5e1"}, grid:{color:"rgba(148,163,184,0.15)"}},
      y:{ticks:{color:"#cbd5e1"}, grid:{color:"rgba(148,163,184,0.15)"}}
    },
    plugins:{legend:{labels:{color:"#e2e8f0", padding:14}}}
  }});
}
document.getElementById("file").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const rows=parseCSV(ev.target.result);
    const frames=rows.map(r=>Number(r.frame_idx));
    const qcGlobal=rows.map(r=>Number(r.global_score||0));
    const blur=rows.map(r=>Number(r.blur_score||0));
    const bright=rows.map(r=>Number(r.brightness_score||0));
    const contrast=rows.map(r=>Number(r.contrast_score||0));
    const dx=rows.map(r=>Number(r.stab_dx||0));
    const dy=rows.map(r=>Number(r.stab_dy||0));
    const motArea=rows.map(r=>Number(r.mot_area_ratio||0)*100);
    const motRegs=rows.map(r=>Number(r.mot_num_regions||0));
    const blocked=rows.map(r=>Number(r.blocked_ratio||0));

    makeLineChart("qcChart", frames, [
      {label:"QC global", data:qcGlobal, borderColor:"#06b6d4", backgroundColor:"rgba(6,182,212,0.20)", tension:0.22, fill:true},
      {label:"Blur", data:blur, borderColor:"#f97316", tension:0.18, fill:false},
      {label:"Bright", data:bright, borderColor:"#a855f7", tension:0.18, fill:false},
      {label:"Contrast", data:contrast, borderColor:"#22c55e", tension:0.18, fill:false}
    ]);

    makeLineChart("stabChart", frames, [
      {label:"dx", data:dx, borderColor:"#f97316", tension:0.2, fill:false},
      {label:"dy", data:dy, borderColor:"#06b6d4", tension:0.2, fill:false}
    ]);

    makeLineChart("motChart", frames, [
      {label:"Área movimiento (%)", data:motArea, borderColor:"#eab308", backgroundColor:"rgba(234,179,8,0.18)", tension:0.2, fill:true},
      {label:"# regiones", data:motRegs, borderColor:"#ef4444", tension:0.2, fill:false, yAxisID:"y1"}
    ]);
    document.getElementById("status").textContent = `Cargado ${rows.length} frames de ${f.name}`;

    // Drift rápido: percentiles de blur y oclusión para seguimiento.
    const blurP90 = percentile(blur, 90).toFixed(1);
    const blurP95 = percentile(blur, 95).toFixed(1);
    const occP90 = percentile(blocked, 90).toFixed(3);
    const occP95 = percentile(blocked, 95).toFixed(3);
    const driftHtml = `Blur p90/p95: ${blurP90} / ${blurP95} · Bloqueo p90/p95: ${occP90} / ${occP95}`;
    document.getElementById("driftStats").textContent = driftHtml;

    // Payload simulado de telemetría
    const payload = {
      device_id: "cam-001",
      model_version: "yolo11n.onnx",
      qc: {
        frames: rows.length,
        blur_p90: Number(blurP90),
        blur_p95: Number(blurP95),
        blocked_p90: Number(occP90),
        blocked_p95: Number(occP95),
      },
      stab: {
        dx_mean: Number((dx.reduce((a,b)=>a+b,0)/(dx.length||1)).toFixed(3)),
        dy_mean: Number((dy.reduce((a,b)=>a+b,0)/(dy.length||1)).toFixed(3)),
      },
      motion: {
        area_mean_pct: Number((motArea.reduce((a,b)=>a+b,0)/(motArea.length||1)).toFixed(2)),
        regions_mean: Number((motRegs.reduce((a,b)=>a+b,0)/(motRegs.length||1)).toFixed(2)),
      },
      generated_at: new Date().toISOString(),
    };
    document.getElementById("simulatePayload").onclick = ()=> {
      document.getElementById("payloadBox").textContent = JSON.stringify(payload, null, 2);
    };
    document.getElementById("payloadBox").textContent = "Pulsa “Simular payload JSON” para ver el ejemplo.";
  };
  reader.readAsText(f);
});
</script>
</html>
